"use strict";class JX{static async post(e,t,{headers:a,raw:o}={headers:{},raw:!1}){let r=!0;if(a){const e=a["Content-Type"]?String(a["Content-Type"]):"application/json; charset=UTF-8";r=a["Content-Type"]?RegExp(/json/i).exec(a["Content-Type"]):r,a["Content-Type"]&&delete a["Content-Type"],a["Content-Type"]=e}try{const n=await window.fetch.bind(window)(e,{headers:a,method:"POST",redirect:"follow",credentials:"include",body:r?JSON.stringify(t):t});return o?n:r?n.json():n.text()}catch(e){console.error(e)}}static async get(e,{headers:t,raw:a}={headers:{},raw:!1}){let o=!0;if(t){const e=t["Content-Type"]?String(t["Content-Type"]):"application/json; charset=UTF-8";o=t["Content-Type"]?RegExp(/json/i).exec(t["Content-Type"]):o,t["Content-Type"]&&delete t["Content-Type"],t["Content-Type"]=e}try{const r=await window.fetch.bind(window)(e,{headers:t,method:"GET",redirect:"follow",credentials:"include",mode:"no-cors"});return a?r:o?r.json():r.text()}catch(e){console.error(e)}}static async consultar(e){e=e.replace(/(\r\n|\n|\r)/gm,"");const t=`${window.location.origin}/mge/service.sbr?serviceName=DbExplorerSP.executeQuery&outputType=json`;let a=`{ "serviceName": "DbExplorerSP.executeQuery", "requestBody": { "sql": "${e}" } }`;return a=JSON.parse(a),function(e){let t=[],a="string"==typeof e?JSON.parse(e):e;a.data?a=a.data.responseBody:a.responseBody&&(a=a.responseBody);let o=a.fieldsMetadata||[],r=a.rows||[];return r.length&&r.forEach(e=>{let a={};o.forEach((t,o)=>a[t.name]=e[o]),t.push(a)}),t}(await JX.post(t,a))}static acionarBotao(e,{tipo:t,idBotao:a,entidade:o,nomeProcedure:r}={tipo:"java",idBotao:0}){function n(e){let t={params:{param:[]}};return Object.keys(e).forEach(a=>t.params.param.push({type:"string"==typeof e[a]?"S":"I",paramName:a,$:e[a]})),t}let s="",i={};switch(t.toLowerCase()){case"js":i={serviceName:s="ActionButtonsSP.executeScript",requestBody:{runScript:{actionID:a,...n(e)}}};break;case"java":i={serviceName:s="ActionButtonsSP.executeJava",requestBody:{javaCall:{actionID:a,...n(e)}}};break;case"sql":if(!o)return void console.error("Entidade (parametro entidade) é necessária para a execução!");if(!r)return void console.error("Nome da procedure (parametro nomeProcedure) é necessária para a execução!");i={serviceName:s="ActionButtonsSP.executeSTP",requestBody:{stpCall:{actionID:a,rootEntity:o,procName:r,...n(e)}}}}const c=`${window.location.origin}/mge/service.sbr?serviceName=${s}&outputType=json`;return JX.post(c,i)}static _salvar(e,t,a){const o=`${window.location.origin}/mge/service.sbr?serviceName=CRUDServiceProvider.saveRecord&outputType=json`,r=function(e,t,a){let o={serviceName:"CRUDServiceProvider.saveRecord",requestBody:{dataSet:{rootEntity:t,includePresentationFields:"N",dataRow:{localFields:Object.keys(e).reduce((t,a)=>({...t,[a.toUpperCase()]:{$:String(e[a])}}),{})},entity:{fieldset:{list:Object.keys(e).map(e=>e.toUpperCase()).join(",")}}}}};if(a){let e={};Object.keys(a).forEach(t=>e={...e,[t.toUpperCase()]:{$:String(a[t])}}),o.requestBody.dataSet.dataRow.key=e}return o}(e,t,a);return JX.post(o,r)}static async salvar(e,t,a){let o=[];if(!(a&&a instanceof Array&&a.length))return JX._salvar(e,t,a);for(let r of a)o.push(await JX._salvar(e,t,r));return o}static deletar(e,t){const a=`${window.location.origin}/mge/service.sbr?serviceName=DatasetSP.removeRecord&outputType=json`,o={serviceName:"DatasetSP.removeRecord",requestBody:{entityName:e,pks:t instanceof Array?t:[t]}};return JX.post(a,o)}static removerFrame({instancia:e,paginaInicial:t,...a}={instancia:"",paginaInicial:"app.jsp"}){new Promise(t=>{window.parent.document.getElementsByTagName("body").length&&(window.parent.document.querySelector("div.gwt-PopupPanel.alert-box.box-shadow")&&(window.parent.document.querySelector("div.gwt-PopupPanel.alert-box.box-shadow").style.display="none"),window.parent.document.getElementsByTagName("body")[0].style.overflow="hidden"),window.parent.parent.document.getElementsByTagName("body").length&&(window.parent.parent.document.querySelector("div.gwt-PopupPanel.alert-box.box-shadow")&&(window.parent.parent.document.querySelector("div.gwt-PopupPanel.alert-box.box-shadow").style.display="none"),window.parent.parent.document.getElementsByTagName("body")[0].style.overflow="hidden"),window.parent.document.querySelector("div.GI-BUHVBPVC > div > div > div > div > div > table > tbody > tr > td > div")&&(e=window.parent.document.querySelector("div.GI-BUHVBPVC > div > div > div > div > div > table > tbody > tr > td > div").textContent),e&&e.length>0?JX.consultar(`SELECT NUGDG FROM TSIGDG WHERE TITULO = '${e}'`).then(e=>t({gadGetID:"html5_z6dld",nuGdt:e[0].NUGDG,...a})):t({gadGetID:"html5_z6dld",nuGdt:0,...a})}).then(e=>setTimeout(()=>{if(void 0!==window.parent.document.getElementsByClassName("DashWindow")[0]){const a=Object.keys(e).filter(e=>!["params","UID","instance","nuGdg","gadGetID"].includes(e)).map(t=>`&${t}=${e[t]}`).join(""),o=`/mge/html5component.mge?entryPoint=${t}&nuGdg=${e.nuGdt}${a}`;setTimeout(()=>window.parent.document.getElementsByClassName("dyna-gadget")[0].innerHTML=`<iframe src="${o}" class="gwt-Frame" style="width: 100%; height: 100%;"></iframe>`,500),setTimeout(()=>document.getElementsByClassName("popupContent").length?document.getElementsByClassName("popupContent")[0].parentElement.remove():void 0,2e4),setTimeout(()=>document.getElementById("stndz-style").parentElement.parentElement.getElementsByTagName("body")[0].style.overflow="hidden",2e4)}}))}static novaGuia(e=!1){(window.parent.parent.document.querySelector(".Taskbar-container")&&!e||e)&&Object.assign(document.createElement("a"),{target:"_blank",href:window.location.href}).click()}static abrirPagina(e,t){let a=JX.getUrl("/mge/system.jsp#app/%resID");if(a=a.replace("%resID",btoa(e)),t){let e={};Object.keys(t).forEach(function(a){e[a]=isNaN(t[a])?String(t[a]):Number(t[a])}),a=a.concat(`/${btoa(JSON.stringify(e))}`)}Object.assign(document.createElement("a"),{target:"_top",href:a}).click()}static fecharPagina(){window.parent.parent.document.querySelector(".Taskbar-container")?window.parent.parent.document.querySelector("li.ListItem.AppItem.AppItem-selected div.Taskbar-icon.icon-close").click():window.close()}static getUrl(e){return`${window.location.origin}${e?"/"+e.replace("/",""):""}`}static getCookie(e){const t=decodeURIComponent(document.cookie);if(e&&"string"==typeof e&&e.length){const a=t.split(";");for(let t of a){let[a,o]=t.split("=");if(a.trim()===e)return o}return""}return t}static getArquivo(e){return JX.get(e,{headers:{"Content-Type":"text/plain"}})}static _converterTuplas(e){let t=[];function a(e,t,o){if(Array.isArray(e))!function(e,t,o){e.forEach(e=>a(e,t,o))}(e,t,o);else if(e&&"object"==typeof e)if(e.hasOwnProperty("key")&&e.hasOwnProperty("value")){let a=function(e){let t=null;switch(e.type){case"L":t="true"===e.value;break;case"I":case"F":t=Number(e.value);break;case"T":t=e.value;break;case"C":t=(e.listContent||"").split("\n")[parseInt(e.value,10)]||null;break;case"D":t=e.value?new Date(e.value.subString(6,10),(Number(e.value.subString(3,5))-1).toString(),e.value.subString(0,2)):null}return t}(e),r=e.name;o.push([t+e.key,a,r])}else Object.keys(e).forEach(r=>{if("node"===r||"nodeName"===r){const n=function(e,t,a){return"nodeName"===a?t+e[a]+".":t}(e,t,r);a(e[r],n,o)}})}return a(e.node,"",t),t}static _montagemSerializacaoParametros(e,t,a=!1){const o={},r=e.flat(1);if(a)for(const e of r){const t=e[0],a=e[1];o[t]=a}else for(const e of t){const t=r.filter(t=>{return[t[0],t[2]].includes(e)})[0];t&&null!==t[1]&&void 0!==t[1]&&""!==t[1]?o[e]=t[1]:o[e]=null}return o}static async getParametro(e=""){if(null==e&&(e=""),!("string"==typeof e||Array.isArray(e)))throw new Error("Forneça o nome dos parametros a serem buscados como Texto ou Array de Textos!");if(Array.isArray(e)&&!e.every(e=>null!=e&&"string"==typeof e&&e.length))throw new Error("Os parametros informados devem ser Textos não vazios!");const t=0===e.length,a="string"==typeof(e=Array.isArray(e)&&t?"":e)||0===e.length?[e]:e,o="ManutencaoPreferenciasSP.getParametrosComoEstrutura",r=`${window.location.origin}/mge/service.sbr?serviceName=${o}&outputType=json`,n={serviceName:o,requestBody:{param:{value:""}}},s=a.map(async e=>{n.requestBody.param.value=e;const t=await JX.post(r,n);return JX._converterTuplas(t.responseBody.root)||[]}),i=await Promise.all(s);return JX._montagemSerializacaoParametros(i,a,t)}static _formatarRequisicaoChamadaServico(e,t,a=!0){let o=null;switch(!0){case a&&t&&"object"==typeof t:e=`${e}&outputType=json`,o=JSON.stringify(t);break;case a&&t&&"string"==typeof t:e=`${e}&outputType=json`,o=t;break;default:o=t}return[e,o]}static _formatarUrlChamadaServico(e,t,a){const o=JX.getCookie("JSESSIONID").replace(/\..*/,"");let r=`${window.location.origin}/${e}/service.sbr?serviceName=${t}&mgeSession=${o}`;const n="&counter=1&preventTransform=false",s=["SelecaoDocumento","br.com.sankhya.mgecom.mov.selecaodedocumento"],i=["MovimentacaoFinanceira","br.com.sankhya.fin.cad.movimentacaoFinanceira"],c=["ConsultaOS","br.com.sankhya.os.mov.OrdemServico"];switch(e){case"mgecom":r=`${r}${n}&application=${s[0]}&resourceID=${s[1]}`;break;case"mgefin":r=`${r}${n}&application=${i[0]}&resourceID=${i[1]}`;break;case"mgeos":r=`${r}${n}&application=${c[0]}&resourceID=${c[1]}`;break;default:r=`${r}${n}&application=${a}`}return r}static async chamarServico(e,t,a={aplicacao:"workspace",cabecalho:{"Content-Type":"application/json; charset=UTF-8"}}){let o="mge",r="workspace",n=null,s={};if(!e||"string"!=typeof e||e.length<1)throw new Error("O serviço deve ser informado!");e.includes("@")&&([o,e]=e.split("@")),a&&(r=a.aplicacao||r,s={...a.cabecalho?a.cabecalho:{}});const i=t&&("string"==typeof t&&!t.startsWith("<")||"object"==typeof t),c={...s,"Content-Type":i?"application/json; charset=UTF-8":"text/xml; charset=UTF-8"};let l=JX._formatarUrlChamadaServico(o,e,r);[l,n]=JX._formatarRequisicaoChamadaServico(l,t,i);const d=await JX.post(l,n,{headers:c,raw:!0});if(!d.ok)throw new Error("[JX] Erro não identificado.");const p=i?await d.json():await d.text();if([0,3].includes(p.status))throw p;return[2,4].includes(p.status)&&console.warn(`[JX] ${p.statusMessage}`),p}}